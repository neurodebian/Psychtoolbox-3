#!/usr/bin/make -f
# -*- makefile -*-

# This has to be exported to make some magic below work.
export DH_OPTIONS

arch=$(shell dpkg --print-architecture )
ifeq ($(arch), amd64)
 # directory suffix for octave
 arch64=64
 # matlab extensions
 mexext=a64
else
 arch64=
 mexext=glx
endif

%:
	dh $@

# 		echo "D: for $$fname mfile is $$mfile";
override_dh_install:
	dh_install
	dh_install -poctave-psychtoolbox-3-nonfree \
		Psychtoolbox/PsychBasic/Octave3LinuxFiles$(arch64)/*.mex \
		usr/lib/psychtoolbox-3/PsychtoolboxAddons/
	dh_install -pmatlab-psychtoolbox-3-nonfree \
		Psychtoolbox/PsychBasic/*.mex$(mexext) \
		Psychtoolbox/PsychHardware/iViewXToolbox/tcp_udp_ip/pnet.mex$(mexext) \
		usr/lib/matlab/site/psychtoolbox-3/
	: # fix permissions
	find debian/*psychtoolbox* -name *.mex* | xargs chmod a-x
	find debian/*psychtoolbox* -name *.mex* -ls

# we need to add links as well into corresponding subdirectories under
# /usr/share/psychtoolbox-3 -- locate by the location of .m file and symlink nearby
# That is why build-depends on octave-psychtoolbox-3
override_dh_link:
	: # Octave pieces
	link_exts() { \
	  pkg=$$1; ext=$$2; \
	  rm -f debian/$$pkg.links; \
	  set -e; /usr/bin/find debian/$$pkd -name *.$$ext | \
	  while read f; do \
		fname=$$(basename $$f); \
		mfile=$$(/usr/bin/find /usr/share/psychtoolbox-3 -name $${fname%.$$ext}.m); \
		[ ! -z "$$mfile" ] || mfile=$$(/usr/bin/find /usr/share/psychtoolbox-3 -name $${fname%.$$ext}.mex); \
		[ ! -z "$$mfile" ] && mdir=$$(dirname $$mfile) || exit 1; \
		echo "/usr/lib$${f#*usr/lib}	$$mdir/$$fname" >> debian/$$pkg.links; \
	  done; };  \
	link_exts octave-psychtoolbox-3-nonfree mex; \
	link_exts matlab-psychtoolbox-3-nonfree mex$(mexext)
	dh_link

override_dh_clean:
	dh_clean
	: # Prune some Debian generated files
	-rm debian/*-nonfree.links

